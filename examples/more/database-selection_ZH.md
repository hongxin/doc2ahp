# 示例：社交应用规模化数据库选型

[English](database-selection.md)

> 场景：一家初创公司正在构建社交媒体平台（结合短内容 + 实时消息 + 推荐的垂直社区应用）。MVP 阶段有 5 万用户，运行在单台 PostgreSQL 实例上。A 轮融资刚刚完成——目标是在 18 个月内达到 1000 万用户。12 人的工程团队需要选择主数据库以支撑规模化。CEO 的要求："信息流绝对不能卡。"

## Step 1: 决策框架构建

**决策目标**：为从 5 万扩展到 1000 万用户的社交应用选择最合适的主数据库

**评估层次**：

```
选择最佳社交应用数据库
├── 数据模型适配度
│   ├── Schema 灵活性（功能持续迭代）
│   ├── 关系查询能力（社交图谱、关注、点赞）
│   └── 全文搜索能力
├── 可扩展性
│   ├── 水平写入扩展
│   ├── 读取性能（信息流生成、时间线）
│   └── 数据量承载（预计 2 年内超过 50TB）
├── 运维卓越性
│   ├── 备份与灾备恢复
│   ├── 监控与调试工具
│   └── 托管服务质量（云服务）
└── 团队与成本
    ├── 学习曲线（团队熟悉 PostgreSQL）
    ├── 社区与文档
    └── 规模化基础设施成本
```

**备选方案**：
- **PostgreSQL + Citus**（PostgreSQL 的水平分片扩展）
- **MongoDB**（原生支持分片的文档数据库）
- **TiDB**（兼容 MySQL 的分布式 NewSQL）

## Step 2: 多视角评估

### 视角 1：后端架构师

| vs | 数据模型适配度 | 可扩展性 | 运维卓越性 | 团队与成本 |
|----|--------------|---------|----------|----------|
| 数据模型适配度 | 1 | 1/2 | 2 | 2 |
| 可扩展性 | 2 | 1 | 3 | 4 |
| 运维卓越性 | 1/2 | 1/3 | 1 | 2 |
| 团队与成本 | 1/2 | 1/4 | 1/2 | 1 |

### 视角 2：SRE / 运维负责人

| vs | 数据模型适配度 | 可扩展性 | 运维卓越性 | 团队与成本 |
|----|--------------|---------|----------|----------|
| 数据模型适配度 | 1 | 1/2 | 1/3 | 1 |
| 可扩展性 | 2 | 1 | 1 | 2 |
| 运维卓越性 | 3 | 1 | 1 | 3 |
| 团队与成本 | 1 | 1/2 | 1/3 | 1 |

### 视角 3：产品工程师

| vs | 数据模型适配度 | 可扩展性 | 运维卓越性 | 团队与成本 |
|----|--------------|---------|----------|----------|
| 数据模型适配度 | 1 | 2 | 2 | 1 |
| 可扩展性 | 1/2 | 1 | 1 | 1/2 |
| 运维卓越性 | 1/2 | 1 | 1 | 1 |
| 团队与成本 | 1 | 2 | 1 | 1 |

## Step 3: 共识聚合

### 权重计算

| 准则 | 行几何平均 | 归一化权重 |
|-----|-----------|----------|
| 数据模型适配度 | 0.93 | 0.22 |
| 可扩展性 | 1.26 | 0.32 |
| 运维卓越性 | 1.10 | 0.27 |
| 团队与成本 | 0.78 | 0.19 |

**权重分布**：
```
可扩展性:       0.32 ████████████████
运维卓越性:     0.27 █████████████
数据模型适配度:  0.22 ███████████
团队与成本:     0.19 █████████
```

## Step 4: 一致性校验

**传递性检查**：
- 可扩展性 > 运维卓越性 > 数据模型适配度 > 团队与成本 ✓
- 可扩展性 > 数据模型适配度 ✓
- 运维卓越性 > 团队与成本 ✓
- 所有传递关系一致 ✓

## Step 5: 方案评分

| 子准则 | 权重 | PostgreSQL + Citus | MongoDB | TiDB |
|-------|------|-------------------|---------|------|
| Schema 灵活性 | 0.08 | 6 | 9 | 7 |
| 关系查询能力 | 0.08 | 9 | 5 | 8 |
| 全文搜索能力 | 0.06 | 7 | 7 | 5 |
| 水平写入扩展 | 0.12 | 7 | 8 | 9 |
| 读取性能 | 0.11 | 8 | 7 | 8 |
| 数据量承载 | 0.09 | 7 | 8 | 9 |
| 备份与恢复 | 0.10 | 9 | 7 | 7 |
| 监控与调试 | 0.09 | 9 | 7 | 7 |
| 托管服务质量 | 0.08 | 8 | 9 | 6 |
| 学习曲线 | 0.07 | 9 | 6 | 8 |
| 社区与文档 | 0.06 | 9 | 8 | 6 |
| 规模化基础设施成本 | 0.06 | 7 | 6 | 5 |

### 加权得分

| 方案 | 加权总分 |
|-----|---------|
| **PostgreSQL + Citus** | **7.75** |
| **MongoDB** | **7.16** |
| **TiDB** | **7.26** |

### 敏感性分析

场景 A — 将"可扩展性"权重从 0.32 提高到 0.50（超高速增长场景）：
- TiDB: 7.58 → **第 1**
- PostgreSQL + Citus: 7.42 → 第 2
- MongoDB: 7.20 → 第 3

场景 B — 将"团队与成本"权重从 0.19 提高到 0.35（预算受限场景）：
- PostgreSQL + Citus: 8.05 → **第 1**（优势进一步扩大）
- MongoDB: 6.98 → 第 3
- TiDB: 7.02 → 第 2

**核心发现**：PostgreSQL + Citus 在各种场景下都是最稳健的选择。TiDB 仅在极端扩展压力（50 倍增长）下才能反超。团队现有的 PostgreSQL 经验是一项显著且实实在在的优势。

## Step 6: 决策报告

# 决策报告：社交应用数据库选型

## 推荐方案
**PostgreSQL + Citus** — 综合得分：7.75 / 10

## 排名

| 排名 | 方案 | 得分 | 核心优势 |
|-----|------|------|---------|
| 1 | PostgreSQL + Citus | 7.75 | 充分利用团队经验，社交图谱关系查询最优，运维工具成熟 |
| 2 | TiDB | 7.26 | 水平扩展能力最强，兼容 MySQL，适合写入密集型场景 |
| 3 | MongoDB | 7.16 | Schema 灵活性最高，上手最容易，托管服务（Atlas）表现优秀 |

## 关键权衡
- **PostgreSQL + Citus vs TiDB**：PostgreSQL 在运维成熟度和团队熟悉度上胜出；TiDB 在自动水平扩展上胜出。两者 0.49 分的差距在超高速增长场景下会显著缩小
- **社交图谱因素**：关系密集型查询（关注者、共同好友、点赞数）正是 PostgreSQL 关系模型的强项。MongoDB 的文档模型在处理这类查询时会显得笨拙，且在大规模下成本高昂
- **MongoDB 的 Schema 灵活性优势**对于快速迭代功能确实有价值，但代价是社交图谱的 JOIN 性能较弱，而社交图谱恰恰是应用的核心数据结构
- **TiDB 的隐性成本**：TiDB 扩展能力出色，但运维分布式 NewSQL 系统所需的专业知识门槛不低，且托管服务选项的成熟度不及 PostgreSQL 和 MongoDB

## 风险提示
- Citus 分片需要在前期精心设计分片键；不当的分布键会导致热点问题，后期重新分片代价昂贵
- PostgreSQL 全文搜索尚可但非顶级；当搜索成为核心功能时，应计划引入 Elasticsearch/Meilisearch
- 用户超过 1000 万后，即使是 Citus 也可能需要配合缓存层（Redis）和专用信息流服务

## 建议
1. 从单机 PostgreSQL 迁移到 PostgreSQL + Citus，按 user_id 分片
2. 引入 Redis 作为热数据缓存层（时间线、会话数据、计数器）
3. 部署读副本用于数据分析和推荐查询
4. 在 100 万用户里程碑时规划专用搜索服务（Meilisearch 或 Elasticsearch）
5. 每周监控查询延迟分布；设置 P95 > 100ms 告警
6. 在 1000 万用户时重新评估 TiDB，若写入扩展成为主要瓶颈
